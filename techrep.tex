% -*- mode: fundamental; -*-

% © CESNET, 2007

\catcode`_=11 % to hide private macros
\catcode`@=11 % to borrow plain TeX macros

% Allocation of registers
\newcount\count_one % temporary counter
\newcount\auth_count % number authors
\newcount\appendix_no % appendix label
\newcount\itemCount % counter for list items
\newcount\foot_count % counter for footnotes
\newcount\tab_count % counter for tables
\newcount\verb_lno % line counter in verbatim listings
\newcount\ruler_count % counter for proof mode ruler numbers
\newdimen\dimen_one % temporary dimension
\newdimen\abs_inset % left and right indentation of abstract
\newdimen\item_indent % amount of item indentation
\newskip\belowabs_skip % below abstract
\newskip\belowkw_skip % below keywords
\newskip\aboveauthors_skip % between the title and authors
\newskip\abovesec_skip % above the section heading
\newskip\abovesubsec_skip % above the subsection heading
\newskip\abovesss_skip % above the subsubsection heading
\newskip\belowauthors_skip % below the title stuff (authors)
\newskip\belowsec_skip % below the section heading
\newskip\belowsubsec_skip % below the subsection heading
\newskip\belowsss_skip % below the subsubsection heading
\newskip\list_skip % above and below lists
\newskip\cap_skip % above/below caption
\newif\ifproof_mode % proof mode switch
\newif\ifin_sec % indicates open section
\newif\ifin_subsec % indicates open subsection
\newif\ifin_sssec % indicates open subsubsection
\newif\iftitle_page % indicates report title page
\newif\ifinfo_up % controls whether headline is set
\newif\ifinfo_down % controls whether footline is set
\newif\iffirst_item % first item of the list
\newif\ifcompact_list % switch for modified handling of short items
\newbox\box_one % temporary box
\newbox\page_box % contains entire page (in output routines)
\newbox\title_box % box for report title
\newbox\auth_box % box for authors
\newbox\para_box % box for entire paragraphs (used in line-numbering mode)
\newbox\fig_box % box for figures
\newbox\vlinebox % vertical line accross the height of a line
\newinsert\margin_ins % marginal insertions (index entries)
\newwrite\inx % index entries
\newwrite\toc % table of contents
\newwrite\xrefs % forward cross-references
\newwrite\comp % comparison of forward cross-refs from both runs
\newtoks\toks_one % temporary tokens
\newtoks\font_style % current font style
\newtoks\leftRunHead % contains left running head
\newtoks\rightRunHead % contains right running head
\newtoks\titl@ % report title
\newtoks\@uthors % comma-separated list of authors

% Basic dimensions
\hsize=159mm
\vsize=690pt
\parindent=6mm

% Macros for general use
\def\macro#1{\csname#1\endcsname}
\def\defMacro#1{\expandafter\def\csname#1\endcsname}
\def\_let#1#2{\expandafter\let\expandafter#1\macro{#2}}
\def\xdef_macro#1{\expandafter\xdef\csname#1\endcsname}
\def\incr#1{\advance#1 by 1}
\def\decr#1{\advance#1 by -1}

% optional parameters (enclosed in [..])
\def\handle_option#1{%  #1 is the macro to be called
    \toks0={\macro{#1}}%
    \futurelet\text\is_option}
\def\is_option{%
    \def\pris{\the\toks0}%
    \ifx\text[\def\text{}%
    \else \def\text{[]}\fi
    \expandafter\pris\text}

% Font macros
\def\text_fam{Baskerville 10 Pro}
\def\mono_fam{Vida Mono 32 Pro}
\def\text_opts{mapping=tex-text}

\font\x_rm="\text_fam:\text_opts"		% 10-point fonts
\font\x_it="\text_fam/I:\text_opts"
\font\x_bf="\text_fam/B:\text_opts"
\font\x_ib="\text_fam/IB:\text_opts"
\font\x_sc="\text_fam:+smcp,\text_opts"
\font\x_i=eurm10
\font\x_eubf=eurb10
\font\x_euex=euex10
\font\x_tt="\mono_fam" at 9pt
\font\x_tti="\mono_fam/I" at 9pt
\font\x_ttb="\mono_fam/B" at 9pt
\font\x_ttib="\mono_fam/IB" at 9pt
\font\x_sy=cmsy10

\font\ix_rm="\text_fam:\text_opts" at 9pt	% 9-point fonts
\font\ix_it="\text_fam/I:\text_opts" at 9pt
\font\ix_bf="\text_fam/B:\text_opts" at 9pt
\font\ix_ib="\text_fam/IB:\text_opts" at 9pt
\font\ix_sc="\text_fam:+smcp,\text_opts" at 9pt
\font\ix_i=eurm9
\font\ix_eubf=eurb9
\font\ix_euex=euex9
\font\ix_tt="\mono_fam" at 8pt
\font\ix_tti="\mono_fam/I" at 8pt
\font\ix_ttb="\mono_fam/B" at 8pt
\font\ix_ttib="\mono_fam/IB" at 8pt
\font\ix_sy=cmsy9

\font\vii_rm="\text_fam:\text_opts" at 7pt	% 7-point fonts
\font\vii_it="\text_fam/I:\text_opts" at 7pt
\font\vii_bf="\text_fam/B:\text_opts" at 7pt
\font\vii_tt="\mono_fam" at 7pt
\font\vii_i=eurm7
\font\vii_eubf=eurb7
\font\vii_euex=euex7
\font\vii_sy=cmsy7

\font\vi_rm="\text_fam:\text_opts" at 6pt	% 6-point fonts
\font\vi_it="\text_fam/I:\text_opts" at 6pt
\font\vi_bf="\text_fam/B:\text_opts" at 6pt
\font\vi_tt="\mono_fam" at 6pt
\font\vi_i=eurm6
\font\vi_eubf=eurb6
\font\vi_sy=cmsy6

\font\v_rm="\text_fam:\text_opts" at 5pt	% 5-point fonts
\font\v_it="\text_fam/I:\text_opts" at 5pt
\font\v_bf="\text_fam/B:\text_opts" at 5pt
\font\v_tt="\mono_fam" at 5pt
\font\v_i=eurm5
\font\v_eubf=eurb5
\font\v_sy=cmsy5

\font\xii_rm="\text_fam:\text_opts" at 12pt	% 12-point fonts
\font\xii_it="\text_fam/I:\text_opts" at 12pt
\font\xii_bf="\text_fam/B:\text_opts" at 12pt
\font\xii_ib="\text_fam/IB:\text_opts" at 12pt
\font\xii_sc="\text_fam:+smcp,\text_opts" at 12pt
\font\xii_i=eurm10 at 12pt
\font\xii_eubf=eurb10 at 12pt
\font\xii_euex=euex10 at 12pt 
\font\xii_tt="\mono_fam" at 11pt
\font\xii_tti="\mono_fam/I" at 11pt
\font\xii_ttb="\mono_fam/B" at 11pt
\font\xii_ttib="\mono_fam/IB" at 11pt
\font\xii_sy=cmsy10 at 12pt

\font\xiv_rm="\text_fam:\text_opts" at 14pt	% 14-point fonts
\font\xiv_it="\text_fam/I:\text_opts" at 14pt
\font\xiv_bf="\text_fam/B:\text_opts" at 14pt
\font\xiv_ib="\text_fam/IB:\text_opts" at 14pt
\font\xiv_sc="\text_fam:+smcp,\text_opts" at 14pt
\font\xiv_i=eurm10 at 14pt
\font\xiv_eubf=eurb10 at 14pt
\font\xiv_euex=euex10 at 14pt 
\font\xiv_tt="\mono_fam" at 13pt
\font\xiv_tti="\mono_fam/I" at 13pt
\font\xiv_ttb="\mono_fam/B" at 13pt
\font\xiv_ttib="\mono_fam/IB" at 13pt
\font\xiv_sy=cmsy10 at 14pt

\font\xvii_rm="\text_fam:\text_opts" at 17pt	% 17-point fonts
\font\xvii_it="\text_fam/I:\text_opts" at 17pt
\font\xvii_bf="\text_fam/B:\text_opts" at 17pt
\font\xvii_ib="\text_fam/IB:\text_opts" at 17pt
\font\xvii_sc="\text_fam:+smcp,\text_opts" at 17pt
\font\xvii_i=eurm10 at 17pt
\font\xvii_eubf=eurb10 at 17pt
\font\xvii_euex=euex10 at 17pt 
\font\xvii_tt="\mono_fam" at 16pt
\font\xvii_tti="\mono_fam/I" at 16pt
\font\xvii_ttb="\mono_fam/B" at 16pt
\font\xvii_ttib="\mono_fam/IB" at 16pt
\font\xvii_sy=cmsy10 at 17pt

\font\xxi_rm="\text_fam:\text_opts" at 21pt	% 21-point fonts
\font\xxi_it="\text_fam/I:\text_opts" at 21pt
\font\xxi_bf="\text_fam/B:\text_opts" at 21pt
\font\xxi_ib="\text_fam/IB:\text_opts" at 21pt
\font\xxi_sc="\text_fam:+smcp,\text_opts" at 21pt
\font\xxi_i=eurm10 at 21pt
\font\xxi_eubf=eurb10 at 21pt
\font\xxi_euex=euex10 at 21pt 
\font\xxi_tt="\mono_fam" at 20pt
\font\xxi_tti="\mono_fam/I" at 20pt
\font\xxi_ttb="\mono_fam/B" at 20pt
\font\xxi_ttib="\mono_fam/IB" at 20pt
\font\xxi_sy=cmsy10 at 21pt

\def\set_families#1#2#3{%
  \textfont0=\macro{#1_rm}\scriptfont0=\macro{#2_rm}%
    \scriptscriptfont0=\macro{#3_rm}%
  \textfont1=\macro{#1_i}\scriptfont1=\macro{#2_i}%
    \scriptscriptfont1=\macro{#3_i}%
  \textfont2=\macro{#1_sy}\scriptfont2=\macro{#2_sy}%
    \scriptscriptfont2=\macro{#3_sy}%
  \textfont3=\macro{#1_euex}\scriptfont3=\macro{#1_euex}
    \scriptscriptfont3=\macro{#1_euex}%
  \textfont\bffam=\macro{#1_bf}%
  \textfont\itfam=\macro{#1_it}%
  \textfont\ttfam=\macro{#1_tt}}

\def\set_styles#1{%
  \def\rm{\macro{#1_rm}\fam0 \font_style={rm}}%
  \def\it{\macro{#1_it}\fam\itfam \font_style={it}}%
  \def\bf{\macro{#1_bf}\fam\bffam \font_style={bf}}%
  \def\ib{\macro{#1_ib}\font_style={ib}}%
  \def\sc{\macro{#1_sc}\font_style={sc}}%
  \def\tt{\macro{#1_tt}\fam\ttfam \font_style={tt}}%
  \def\tti{\macro{#1_tti}\font_style={tti}}%
  \def\ttib{\macro{#1_ttib}\font_style={ttib}}%
  }

\def\sl{\it}

\def\set_line_sizes#1#2#3{\normalbaselineskip=#1%
  \normallineskip=#2\normallineskiplimit=#3\normalbaselines
  \dimen_one=\baselineskip
  \divide\dimen_one by 3
  \setbox\strutbox=\hbox{\vrule height 2.4\dimen_one
    depth 0.6\dimen_one width 0pt}%
  \setbox\vlinebox=\hbox{\vrule height 2.4\dimen_one
    depth 0.6\dimen_one}%
  \bigskipamount=3\dimen_one plus1\dimen_one minus1\dimen_one
  \medskipamount=\bigskipamount \divide\medskipamount by 2
  \smallskipamount=\medskipamount \divide\smallskipamount by 2}

\def\strut{\copy\strutbox}
\def\vline{\copy\vlinebox}

\def\tenPoint{\set_styles{x}%
  \set_families{x}{vii}{v}%
  \set_line_sizes{13pt}{0pt}{0pt}%
  \macro{\the\font_style}}

\def\twelvePoint{\set_styles{xii}%
  \set_families{xii}{ix}{vi}%
  \set_line_sizes{15pt}{0pt}{0pt}%
  \macro{\the\font_style}}

\def\fourteenPoint{\set_styles{xiv}%
  \set_families{xiv}{x}{vii}%
  \set_line_sizes{18pt}{0pt}{0pt}%
  \macro{\the\font_style}}

\def\seventeenPoint{\set_styles{xvii}%
  \set_families{xvii}{xii}{ix}%
  \set_line_sizes{21pt}{0pt}{0pt}%
  \macro{\the\font_style}}

\let\normalSize=\twelvePoint
\let\petit=\tenPoint
\def\titleFont{\seventeenPoint\bf}
\def\sectionFont{\fourteenPoint\bf}
\def\subsectionFont{\normalSize\bf}
\def\sssectionFont{\normalSize\bf}

% mapping of special characters (via XeTeX)

\catcode`＃=\active
\catcode`＄=\active
\catcode`％=\active
\catcode`＆=\active
\catcode`＼=\active
\catcode`＾=\active
\catcode`＿=\active
\catcode`｛=\active
\catcode`｝=\active
\catcode`～=\active

\chardef＃=`\#
\chardef＄=`\$
\chardef％=`\%
\chardef＆=`\&
\chardef＼=`\\
\chardef＾=`\^
\chardef＿=`\_
\chardef｛=`\{
\chardef｝=`\}
\chardef～=`\~

% Processing modes
\def\proofMode{\proof_modetrue}
\def\finalMode{\proof_modefalse}

% \output routines
\newinsert\margin_ins % marginal insertions (used for index entries)
\dimen\margin_ins=\maxdimen
\count\margin_ins=0 \skip\margin_ins=0pt % marginal inserts take up no space
\ruler_count=0

\def\pagecontents{\ifvoid\margin_ins\else % marginal info is present
    \rightline{\rlap{\kern1pc\vbox to\z@{\box\margin_ins \vss}}}\fi
  \ifvoid\topins\else\unvbox\topins\fi
  \dimen@=\dp\@cclv \unvbox\@cclv % open up \box255
  \ifvoid\footins\else % footnote info is present
    \vskip\skip\footins
    \footnoterule
    \unvbox\footins\fi
  \ifr@ggedbottom \kern-\dimen@ \vfil \fi}
\def\one_page_out{%
    \iftitle_page \info_upfalse \info_downtrue \global\title_pagefalse
    \else \info_uptrue \info_downfalse\fi
    \ifproof_mode\proof_output\else\plainoutput\fi}
\def\tick_rule{\hrule width1mm}
\def\make_tick{\global\incr\ruler_count
  \vbox to15pt{\tick_rule
    \leaders\vrule\vfil
    \hbox to1cm{\ix_rm\number\ruler_count \hfil}
    \leaders\vrule\vfil}}
\def\ruler_box{\vbox{\special{color push Blue}\offinterlineskip
  \dimen_one=0pt
  \make_tick
  \loop\ifdim\dimen_one<\ht\page_box
    \advance\dimen_one by 15pt
    \make_tick\repeat
  \tick_rule
  \special{color pop}}}
\def\proof_output{\setbox\page_box=\pagebody
  \shipout\vbox{\makeheadline
    \hbox to\hsize{\hss\ruler_box
      \kern1em \box\page_box}%
    \makefootline}%
  \advancepageno
  \ifnum\outputpenalty>-20000 \else\dosupereject\fi}
\output={\one_page_out}

% Head- and footline
\def\makeheadline{\vbox to 0pt{\skip0=\topskip
\advance\skip0 by -2.75\baselineskip \vskip\skip0
  \hbox to \hsize{\normalSize\strut
    \ifodd\pageno
	\ifinfo_up{\x_rm\hfil\the\rightRunHead}\else\hfil\fi
    \else\ifinfo_up{\x_rm\the\leftRunHead\hfil}\fi\fi}\vss}%
    \nointerlineskip}
\def\makefootline{\baselineskip=2\normalbaselineskip
\hbox to \hsize{\the\footline}}
\footline={\ifinfo_down
    \ifnum\pageno<0 \hfil\folio\hfil \else {\petit
        \ifproof_mode PROOF \number\day.\number\month.\number\year\else
            © CESNET, \number\year\fi}\hfil\fi\fi}

% Front matter

\aboveauthors_skip=30pt plus 8pt
\belowauthors_skip=30pt plus 8pt
\belowabs_skip=12pt minus6pt
\belowkw_skip=30pt plus 15pt minus6pt
\abs_inset=3em

\def\report{%
    \foot_count=0 \auth_count=0
    \let\short_title=\empty
    \title_pagetrue}

\def\endReport{\vfill\supereject\end}

\def\title#1{\titl@={#1}%
    \setbox\title_box=\vbox{%
    \leftskip=3em plus 1fill \rightskip=3em plus 1fill
    \parfillskip=0pt
    \titleFont\noindent\the\titl@\par}}

\def\shortTitle#1{\def\short_title{#1}}

\def\author#1{\ifnum\auth_count=0
        \@uthors={#1}\def\first_author{#1}\else
        \@uthors=\expandafter{\the\@uthors, #1}\fi
    \incr\auth_count}

\def\makeTitle{\edef\the_title{\the\titl@}%
    \leftRunHead={{\x_i\folio}\kern2em{\x_sc\ifnum\auth_count>3
        \first_author~et~al.\else \the\@uthors\fi}}%
    \rightRunHead={{\petit\ifx\short_title\empty
        \it\the\titl@\else\short_title\fi\kern2em$\x_i\folio$}}%
    \box\title_box
    \vskip\aboveauthors_skip
    \vbox{\leftskip=3em plus 1fill \rightskip=3em plus 1fill
    \parfillskip=0pt
    \normalSize\noindent\sc\the\@uthors}
    \vskip\belowauthors_skip}

\def\abstract{\bgroup\petit
    \centerline{\bf Abstract}
    \advance\leftskip by \abs_inset
    \advance\hsize by -\abs_inset}

\def\endAbstract{\par\egroup\vskip\belowabs_skip}

\def\keywords#1{\vbox{
    \advance\leftskip by \abs_inset
    \advance\hsize by -\abs_inset
    \petit\noindent
    {\sl Keywords:} #1\par}
    \vskip\belowkw_skip}

% Sectioning macros
\abovesec_skip=23pt plus 7pt
\belowsec_skip=12pt plus 1pt
\abovesubsec_skip=18pt plus 3pt
\belowsubsec_skip=8pt plus 1pt
\abovesss_skip=18pt plus 3pt
\belowsss_skip=8pt plus 1pt

\def\set_heading_box#1#2#3#4#5{\setbox0=\hbox{#2#3}%
    \setbox0=\vbox{#2%\hrule height0pt
        \skip0=#1
        \vskip \ifx\par\endgraf \else .5\fi\skip0
        \hangindent=\wd0
        \hangafter=1 \parskip=0pt
        \hyphenpenalty=10000 \rightskip=0pt plus 5em
        \noindent#3#4\par\nobreak\vskip#5}}

\def\set_heading{\unvbox0
    \vskip-\parskip\ignorespaces}

\def\check_leftspace{\dimen0=\pagetotal
    \advance\dimen0 by -\pageshrink
    \ifdim\dimen0>\pagegoal
    \else\dimen0=\pagetotal
         \advance\dimen0 by \pagestretch
         \ifdim\dimen0<\pagegoal \dimen0=\pagetotal
             \advance\dimen0 by \ht0
             \advance\dimen0 by 3\baselineskip
             \ifdim\dimen0>\pagegoal \vfill\eject\fi
             \else\eject\fi\fi}

\def\section#1#2{\ifvmode\else\par\fi
    \set_heading_box\abovesec_skip\sectionFont
        {#1\kern1em}{#2}\belowsec_skip
    \check_leftspace
    \set_heading}

\def\subsection#1#2{\ifvmode\else\par\fi
    \set_heading_box\abovesubsec_skip\subsectionFont
        {#1\kern1em}{#2}\belowsubsec_skip
    \check_leftspace
    \set_heading}

\def\subsubsection#1#2{\ifvmode\else\par\fi
    \set_heading_box\abovesss_skip\sssectionFont
        {#1\kern1em}{#2\kern1em}\belowsss_skip
    \check_leftspace
    \set_heading}

\def\appendix#1#2{\ifvmode\else\par\fi
    \set_heading_box\abovesec_skip\sectionFont
        {Appendix~#1.\kern1em}{#2}\belowsec_skip
    \check_leftspace
    \set_heading}

% Verbatim mode - terminated by U+00A4 (CURRENCY SIGN)

\def\uncatcode_specials{\def\do##1{\catcode`##1=12 }\dospecials}
{\obeyspaces\global\let =\ }

\def\numberedVerbatim{\par\begingroup\tt
  \verb_lno=0
  \obeylines\uncatcode_specials\obeyspaces
  \everypar={\incr\verb_lno
    \llap{\hbox to\parindent{%
        \hfil{\ix_i\number\verb_lno\ \ }}}}}

\def\verbatim{\par\medskip\begingroup\tt\parindent=0pt
  \obeylines\uncatcode_specials\obeyspaces}

\def\endVerbatim{\endgroup\medbreak}

\catcode`\¤=\active \let¤=\endVerbatim

\def\blockQuote{\par\begingroup\nobreak\medskip
    \hrule\kern1pt\nobreak}

\def\endBlockQuote{\nobreak\kern1pt\hrule\endgroup\medbreak}

% Lists

\item_indent=\ifdim\parindent<5mm 5mm\else\parindent\fi
\list_skip=3pt plus1pt minus2pt
\compact_listfalse

\def\compactList{\compact_listtrue}

\def\begin_list{\handle_option{begin_list_}}
\def\begin_list_[#1]{\par\goodbreak
    \def\pris{#1}
    \vskip\list_skip\bgroup
    \advance\leftskip by \ifx\pris\empty \item_indent \else\pris\fi
    \first_itemtrue
    \itemCount=0}

\def\endList{\par\egroup\vskip\list_skip}

\def\list_item{\iffirst_item \par\first_itemfalse
    \else \par\goodbreak \ifcompact_list\vskip-\parskip\fi
  \fi
  \incr\itemCount
  \noindent
  \llap{\hbox to \item_indent{\hss\list_label\kern2mm}}%
  \ignorespaces}

\def\ASCII_item#1{%
  \count_one=\itemCount \advance\count_one by #1
  \def\list_label{\char\number\count_one.}\list_item}

\def\unorderedList{\handle_option{unorderedList_}}
\def\unorderedList_[#1]{\begin_list
    \def\pris{#1}%
    \edef\list_label{\ifx\pris\empty •\else\pris\fi}
    \let\item=\list_item}

\def\orderedList{\handle_option{orderedList_}}
\def\orderedList_[#1]{\begin_list
    \def\pris{#1}\ifx\pris\empty \arabic_list
        \else \macro{#1_list}\fi}

\def\arabic_item{
  \def\list_label{\number\itemCount.}\list_item}
\def\arabic_list{\let\item=\arabic_item}

\def\roman_item{%
  \def\list_label{(\romannumeral\itemCount)}\list_item}
\def\roman_list{\let\item=\roman_item}

\def\ROMAN_item{%
  \def\list_label{(\uppercase{\romannumeral\itemCount})}\list_item}
\def\ROMAN_list{\let\item=\ROMAN_item}

\def\alpha_item{\ASCII_item{96}}
\def\alpha_list{\let\item=\alpha_item}

\def\ALPHA_item{\ASCII_item{64}}
\def\ALPHA_list{\let\item=\ALPHA_item}

\def\definitionList{\par\vskip\list_skip\bgroup
    \parindent=0pt \parskip=2pt plus1pt \first_itemtrue
    \advance\leftskip by \item_indent}

\def\term#1{\par\iffirst_item \first_itemfalse\else \medbreak\fi
    \hbox{\it #1}}

\def\description{\indent\ignorespaces}

\def\bibList{\setbox\box_one\hbox{[99] }%
  \begin_list[\wd\box_one]}

\def\bibItem#1{\def\list_label{[#1]}\list_item}

% Footnotes
\skip\footins=14.5pt plus 2pt minus 4pt % added when footnote is present
\dimen\footins=30pc % maximum footnotes per page

\def\foot_mark{${}^{\number\foot_count}$}

\def\footNote{\global\incr\foot_count
  \let\@sf\empty
  \ifhmode\edef\@sf{\spacefactor\the\spacefactor}\/\fi
  \foot_mark\@sf\vfootnote{\foot_mark}}  

\def\fo@t{\petit\ifcat\bgroup\noexpand\next \let\next\f@@t
  \else\let\next\f@t\fi \next}

% Figures and tables
\def\pdf_fmt{PDF}
\cap_skip=12pt plus1pt minus2pt

\def\figure#1{\par\midinsert\vskip5mm plus 6pt minus3pt
    \def\cap_label{Figure~#1}}
\def\endFigure{\vskip0pt plus 6pt minus3pt\endinsert}

\def\image{\handle_option{image_}}
\def\image_[#1]#2#3{\def\pris{#1}%
  \def\pic_fmt{#2}%
  \ifx\pic_fmt\pdf_fmt
    \let\pic_cs=\XeTeXpdffile
  \else
    \let\pic_cs=\XeTeXpicfile
  \fi
  \ifx\pris\empty
    \setbox\fig_box=\hbox{\pic_cs "#3"\relax}%
    \ifdim\wd\fig_box>\hsize
      \centerline{\pic_cs "#3" width \hsize}%
    \else
      \centerline{\unhbox\fig_box}%
    \fi
  \else
    \centerline{\pic_cs "#3" scaled #1}%
  \fi}

\def\caption{\medskip\vbox\bgroup\raggedright
    \advance\leftskip by 2\parindent
    \advance\rightskip by 2\parindent
    \setbox0=\hbox{\bf\cap_label.\space}
    \advance\leftskip by \wd0
    \noindent\llap{\box0}\ignorespaces}
\def\endCaption{\par\egroup\smallskip}

\def\centerCaption#1{\medskip\centerline{{\bf\cap_label.}~#1}\smallskip}

\def\table#1{\par\midinsert\vskip5mm plus 6pt minus3pt
    \def\cap_label{Table~#1}}
\def\endTable{\medskip\vskip0pt plus 6pt minus3pt\endinsert}

% Final touches
\catcode`\_=8 % make _ again subscript symbol
\catcode`@=12 % at signs are no longer letters

\normalSize\rm
\widowpenalty=300
\proofMode
